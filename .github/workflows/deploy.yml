name: Build and Deploy
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Create .nojekyll file
        run: |
          touch .nojekyll
          echo "Created .nojekyll file to bypass Jekyll processing"
        
      - name: Update index.html with embedded configuration
        run: |
          # Insert configuration right before main.js script
          sed -i 's/<script src="main.js"><\/script>/<script>\
          \/\/ Configuration generated by GitHub Actions\
          window.ENV = {\
              EMAILJS_SERVICE_ID: "${{ secrets.EMAILJS_SERVICE_ID }}",\
              EMAILJS_TEMPLATE_ID: "${{ secrets.EMAILJS_TEMPLATE_ID }}",\
              EMAILJS_USER_ID: "${{ secrets.EMAILJS_USER_ID }}",\
              RESUME_LINK: "${{ secrets.RESUME_LINK }}"\
          };\
          <\/script>\
          <script src="main.js"><\/script>/g' index.html
      
      - name: Update form handler with error checking
        run: |
          # Add safety checks to form handler
          sed -i 's/resume_link: window.ENV.RESUME_LINK/resume_link: window.ENV ? window.ENV.RESUME_LINK : "https:\/\/praveenganapathy.github.io\/online-resume\/PraveenGanapathyRavi_Resume.pdf"/g' main.js
          sed -i 's/window.ENV.EMAILJS_SERVICE_ID/window.ENV ? window.ENV.EMAILJS_SERVICE_ID : "service_o5jyuif"/g' main.js
          sed -i 's/window.ENV.EMAILJS_TEMPLATE_ID/window.ENV ? window.ENV.EMAILJS_TEMPLATE_ID : "template_rer0jo8"/g' main.js
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: .
          clean: true
          force: true